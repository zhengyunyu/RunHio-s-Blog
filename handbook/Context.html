<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <title>Context | RunHio前端文档</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="个人前端学习笔记">
    
    <link rel="preload" href="/RunHio-s-Blog/assets/css/0.styles.9da74c16.css" as="style"><link rel="preload" href="/RunHio-s-Blog/assets/js/app.cc02781b.js" as="script"><link rel="preload" href="/RunHio-s-Blog/assets/js/3.d30309d1.js" as="script"><link rel="preload" href="/RunHio-s-Blog/assets/js/1.600c0749.js" as="script"><link rel="preload" href="/RunHio-s-Blog/assets/js/13.032ea566.js" as="script"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/10.1c422d82.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/11.97081ff6.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/12.6279b31e.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/14.1fd78a52.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/15.e3903c0b.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/16.f41c2c93.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/17.01531842.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/18.d97a2afd.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/19.7ee1ae59.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/20.5b8d259e.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/21.02f2ef0a.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/22.8ab3213c.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/4.5f40dcd3.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/5.3d52dacf.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/6.1f7fb6f9.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/7.124ff2e2.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/8.0ca9916b.js"><link rel="prefetch" href="/RunHio-s-Blog/assets/js/9.cabfd1ef.js">
    <link rel="stylesheet" href="/RunHio-s-Blog/assets/css/0.styles.9da74c16.css">
    <meta id="referrer" name="referrer" content="never" />
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1aefc0b4><div data-v-1aefc0b4><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1aefc0b4 data-v-1aefc0b4><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>RunHio前端文档</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>个人前端学习笔记</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1aefc0b4><header class="navbar" data-v-1aefc0b4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/RunHio-s-Blog/" class="home-link router-link-active"><!----> <span class="site-name">RunHio前端文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/RunHio-s-Blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      RunHio的前端博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhengyunyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1aefc0b4></div> <aside class="sidebar" data-v-1aefc0b4><div class="personal-info-wrapper" data-v-39576ba9 data-v-1aefc0b4><!----> <!----> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>12</h3> <h6 data-v-39576ba9>文章</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>0</h3> <h6 data-v-39576ba9>标签</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/RunHio-s-Blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      RunHio的前端博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhengyunyu" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/RunHio-s-Blog/handbook/type.html" class="sidebar-link">Type</a></li><li><a href="/RunHio-s-Blog/handbook/String&amp;Number.html" class="sidebar-link">String&amp;Number</a></li><li><a href="/RunHio-s-Blog/handbook/Map&amp;Set.html" class="sidebar-link">Map&amp;Set</a></li><li><a href="/RunHio-s-Blog/handbook/Array.html" class="sidebar-link">Array</a></li><li><a href="/RunHio-s-Blog/handbook/Symbol.html" class="sidebar-link">Symbol</a></li><li><a href="/RunHio-s-Blog/handbook/Proxy&amp;Reflect.html" class="sidebar-link">Proxy&amp;Reflect</a></li><li><a href="/RunHio-s-Blog/handbook/GC.html" class="sidebar-link">GC</a></li><li><a href="/RunHio-s-Blog/handbook/Context.html" aria-current="page" class="active sidebar-link">Context</a></li><li><a href="/RunHio-s-Blog/handbook/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/RunHio-s-Blog/handbook/EventLoop.html" class="sidebar-link">EventLoop</a></li><li><a href="/RunHio-s-Blog/handbook/Browser.html" class="sidebar-link">Browser</a></li><li><a href="/RunHio-s-Blog/handbook/Webpack.html" class="sidebar-link">Webpack</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-1aefc0b4><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Context</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><!---->
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1aefc0b4><main class="page"><section><div class="page-title"><h1 class="title">Context</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>RunHio</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2021/12/12</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="词法环境"><a href="#词法环境" class="header-anchor">#</a> 词法环境</h1> <h2 id="lexical-environments"><a href="#lexical-environments" class="header-anchor">#</a> Lexical Environments</h2> <p>Lexical Environment，又称为词法环境，它与源程序的结构对应，简而言之词法环境就是相应代码块内<strong>标识符与值的关联关系体现</strong>，写代码的时候该环境就已经确定了。如下图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638534379521-2000b7ea-f515-4706-9268-4075d128e688.webp" alt="img"></p> <p>词法环境是在进入上述几种代码结构之前就创建完毕,就像学校开课前学生的信息就已经登记完毕了</p> <p>词法环境由两部分构成:</p> <ul><li>Environment Records :登记变量的地方 叫环境记录</li></ul> <p>可以理解为相应代码块内的所有变量声明、函数声明都存储于此</p> <ul><li>outer:指向,包含本词法环境的外部词法环境,就是指向外部词法环境的引用</li></ul> <p>用伪代码表示如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">LexicalEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>EnvironmentRecord <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outer <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">//outer Environment Reference</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="environmentrecord"><a href="#environmentrecord" class="header-anchor">#</a> EnvironmentRecord</h3> <p>环境记录中分为两类:</p> <ul><li>declarative environment records 声明式环境记录</li> <li>object environment records 对象式环境记录</li></ul> <p><strong>declarative environment records</strong> 可以理解为字典类型的结构,以key-value的形式对应名字和值。声明式环境记录是用来定义那些直接将标识符与语言值绑定的ES语法元素，例如变量，常量，let，class，module，iport等。</p> <p><strong>object environment records</strong> 会关联一个对象，这个对象叫做对象式环境记录的binding object，用这个对象中的属性-值来登记变量对应的名字和值。是对象就可以动态地删除或添加属性，所以对象环境记录不存在不可变绑定，用来记录标识符与某些对象属性相绑定的ES语法元素，例如with语句，全局var声明，全部函数声明等。</p> <h2 id="全局环境"><a href="#全局环境" class="header-anchor">#</a> 全局环境</h2> <h3 id="globalenvironment"><a href="#globalenvironment" class="header-anchor">#</a> GlobalEnvironment</h3> <p>GlobalEnvironment是一个特殊的Lexical Environment,他的outer为null。</p> <p>可以把他看作是对一个<strong>对象式环境记录组件</strong>和一个<strong>声明式环境记录组件</strong>的封装。</p> <p>全局环境记录的对象式环境记录的binging object就是全局对象，浏览器里面就是window。</p> <p>全局环境记录的<strong>对象式环境记录</strong>，绑定了所有内置的全局属性、全局函数声明以及全局的var声明，所以我们可以通过window.xxx或this.xxx取到全局声明。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> num<span class="token operator">=</span><span class="token number">0</span>
window<span class="token punctuation">.</span>num <span class="token comment">//0</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token comment">//0</span>
</code></pre></div><p>而全局环境中的其他声明，如let const等则绑定在全局环境的<strong>声明式环境记录</strong>，由于声明式环境记录不是简单的对象形式，所以这些声明我们并不能通过全局的对象属性去访问。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> myName<span class="token operator">=</span><span class="token string">'front'</span>
<span class="token keyword">const</span> mySex<span class="token operator">=</span><span class="token string">'male'</span>
window<span class="token punctuation">.</span>myName <span class="token comment">//undefined</span>
myName <span class="token comment">//front</span>
</code></pre></div><h3 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">20</span>
<span class="token keyword">const</span> z <span class="token operator">=</span> <span class="token number">30</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>对以上代码进行环境解析，可以得到如下：</p> <p>一个全局的词法环境和foo函数的词法环境</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 全局词法环境</span>
GlobalEnvironment <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">outer</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 全局环境的外部环境引用为null</span>
    <span class="token comment">// 全局环境记录，抽象为一个声明式环境记录和一个对象式环境记录的封装</span>
    <span class="token literal-property property">GlobalEnvironmentRecord</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 全局this绑定值指向全局对象，即ObjectEnvironmentRecord的binding object</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>GlobalThisValue<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> ObjectEnvironmentRecord<span class="token punctuation">[</span><span class="token punctuation">[</span>BindingObject<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 声明式环境记录，全局除了函数和var，其他声明绑定于此</span>
        <span class="token literal-property property">DeclarativeEnvironmentRecord</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
            <span class="token literal-property property">Person</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">class</span><span class="token operator">&gt;&gt;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 对象式环境记录的，绑定对象为全局对象，故其中的绑定可以通过访问全局对象的属性来获得</span>
        <span class="token literal-property property">ObjectEnvironmentRecord</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 全局函数声明和var声明</span>
            <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token comment">// 内置全局属性</span>
            <span class="token literal-property property">isNaN</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">isFinite</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">parseInt</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">parseFloat</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span><span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">Array</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span>construct <span class="token keyword">function</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">Object</span><span class="token operator">:</span> <span class="token operator">&lt;&lt;</span>construct <span class="token keyword">function</span><span class="token operator">&gt;&gt;</span>
            <span class="token comment">// 其他内置全局属性不一一列举</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// foo函数词法环境</span>
fooFunctionEnviroment <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">outer</span><span class="token operator">:</span> GlobalEnvironment<span class="token punctuation">,</span> <span class="token comment">// 外部词法环境引用指向全局环境</span>
    <span class="token literal-property property">FunctionEnvironmentRecord</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>ThisValue<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> GlobalEnvironment<span class="token punctuation">,</span> <span class="token comment">// foo函数全局调用，故this绑定指向全局环境</span>
        <span class="token comment">// 其他函数代码内的绑定</span>
        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="全局标识符解析"><a href="#全局标识符解析" class="header-anchor">#</a> 全局标识符解析</h3> <p>由于全局环境记录是声明式环境记录和对象式环境记录的封装，所以其解析也有所不同。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">GetGlobalBingingValue</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全局环境记录</span>
    <span class="token keyword">let</span> rec <span class="token operator">=</span> Global Environment Record
    <span class="token comment">// 全局环境记录的声明式环境记录</span>
    <span class="token keyword">let</span> DecRec <span class="token operator">=</span> rec<span class="token punctuation">.</span>DeclarativeRecord
    <span class="token comment">// HasBinding用来检查环境记录上是否绑定给定标识符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DecRec<span class="token punctuation">.</span><span class="token function">HasBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DecRec<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> ObjRec <span class="token operator">=</span> rec<span class="token punctuation">.</span>ObjectRecord
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ObjRec<span class="token punctuation">.</span><span class="token function">HasBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ObjRec<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token function">ReferenceError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not defined</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到读取变量时是先检索声明式环境记录，再检索对象式环境记录。</p> <ul><li>let const等声明的变量如果存在同名var变量或函数声明就会报错。但是如果我们使用let const声明变量，然后直接通过给全局对象添加一个同名属性，就可以绕过此报错。</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638710991497-6184ec65-4786-4f78-918f-d6c0ecfbc955.webp" alt="img"></p> <h2 id="execution-context"><a href="#execution-context" class="header-anchor">#</a> Execution Context</h2> <h3 id="execution-context-2"><a href="#execution-context-2" class="header-anchor">#</a> Execution Context</h3> <p>Execution Context为运行上下文,它由三部分组成:</p> <ul><li><p>LexicalEnvironment 词法环境组件</p></li> <li><p>VariableEnvironment 变量环境组件</p></li> <li><p>ThisBinding</p></li></ul> <p>LexicalEnvironment和VariableEnvrionment都指向了词法环境Lexcial Environment.</p> <p>注意:运行上下文(Execution Contexts)中的LexicalEnvironment是名称，它的值是一个Lexical Environment（词法环境），不要搞混。</p> <p>在任意的JavaScript可执行代码被执行的时候，执行步骤如下：</p> <ol><li><p>创建一个<strong>新的执行上下文</strong></p></li> <li><p>创建一个<strong>新的词法环境</strong></p></li> <li><p>将该执行上下文的<strong>变量环境组件VariableEnvironment</strong>和<strong>词法环境组件LexicalEnvironment</strong>都指向新创建的词法环境</p></li> <li><p>将该执行上下文<strong>推入执行上下文栈</strong>并成为<strong>正在运行执行上下文</strong></p></li> <li><p>对代码块内的<strong>标识符进行实例化及初始化</strong></p></li> <li><p>运行代码</p></li> <li><p>运行完毕后将该运行上下文出栈</p></li></ol> <h3 id="hoisting"><a href="#hoisting" class="header-anchor">#</a> Hoisting</h3> <p>Hoisting就是变量提升，发生在执行步骤的第四步，对代码块内的标识符进行实例化和初始化的具体表现如下：</p> <ol><li><p>将let const class声明的标识符合集记录为<strong>lexNames</strong></p></li> <li><p>将var function声明的标识符合集记录为<strong>varNames</strong></p></li> <li><p>如果lexNames内的任何标识符出现在lexNames或varNames中，则报错<strong>SyntaxError</strong></p></li></ol> <p>这就是为什么var可以声明多个同名变量，而let这些则不行</p> <ol><li>将varNames内的var声明的标识符<strong>实例化并初始化为undefined</strong>，有同名标识符则跳过</li></ol> <p>这就是所谓的变量提升，用var声明的变量在声明位置之前访问都不会报错，而是返回undefined</p> <ol><li>将lexNames中的<strong>标识符实例化，但不会初始化</strong>，在运行至声明处时才会进行初始化</li></ol> <p>这就是所谓的暂时性死区，let等声明的变量其实也提升了，但是没有初始化，初始化前访问就会报错</p> <ol><li>最后将varNames中的函数声明<strong>实例化并赋值对应的函数体</strong>，如果有同名函数则只有最后一个函数会被初始化赋值</li></ol> <p>函数声明会被直接赋值，所以我们可以在函数声明位置前调用</p> <h3 id="lexicalenvironment和variableenvironment"><a href="#lexicalenvironment和variableenvironment" class="header-anchor">#</a> LexicalEnvironment和VariableEnvironment</h3> <p>变量环境组件用于记录var声明的绑定</p> <p>词法环境组件用于记录其他声明的组件，如let const等</p> <p>一般情况下一个Execution Context内的VariableEnvrionment和LexicalEnvrionment都指向同一个词法环境，之所以要区分两个组件，主要是为了<strong>实现块级作用域的同时不影响var声明和函数声明</strong></p> <ol><li><p>首先在一个正在运行的执行上下文内，词法环境由VariableEnvironment和LexicalEnvironment组成，此执行上下文内的所有标识符的绑定都记录在两个组件的环境记录中</p></li> <li><p>当运行到块级代码时，会将LexicalEnvironment记录下来，记录为oldEnv</p></li> <li><p>然后创建一个新的LexicalEnvironment，outer指向oldEnv，将其记录为newEnv，并将运行时上下文的LexicalEnvironment指向newEnv</p></li> <li><p>块级代码中的let const class都绑定在newEnv中，而var则绑定在原本的VariableEnvironment中</p></li> <li><p>块级代码运行完毕之后，将oldEnv还原为原本的LexicalEnvironment</p></li></ol> <h3 id="案例"><a href="#案例" class="header-anchor">#</a> 案例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>第一步 初始化运行环境</strong></p> <p>当js引擎要开始进行全局代码运行之前，会创建一个全局上下文，并放入运行栈中</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638719350561-8ab24735-0660-4e59-b27b-0e63f1e49439.webp" alt="img"></p> <p><strong>第二步 提升</strong></p> <p>找到var声明和函数声明，登记到Context的VariableEnvironment中</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638719444302-fbf1140c-6c8b-482a-bc36-c58e8be677ae.webp" alt="img"></p> <p>找到函数声明后，创建函数对象fo。</p> <p>此时代码还没执行，环境中就已经有了a和print的记录，而且print的值是一个可以实实在在运行的函数对象而不是undefined。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638719515058-0fdcd67e-49e8-4e40-9c9a-2df718c381e6.webp" alt="img"></p> <p><strong>第三步 执行代码</strong></p> <p>对a进行赋值</p> <p>调用print()</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638719722830-4d797bb7-2386-4d58-9274-a65764d7b059.webp" alt="img"></p> <p>执行完毕之后退出当前运行上下文并把其从调用栈中移除</p> <h2 id="函数创建"><a href="#函数创建" class="header-anchor">#</a> 函数创建</h2> <h3 id="scope-属性"><a href="#scope-属性" class="header-anchor">#</a> [[scope]]属性</h3> <p>函数一创建，就自带了一个scope属性，这个属性存放着函数创建时候的词法环境，是函数先天的作用域。</p> <h3 id="函数表达式和函数声明"><a href="#函数表达式和函数声明" class="header-anchor">#</a> 函数表达式和函数声明</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">funndec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Declarations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">funcOne</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">funname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//命名函数表达式</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Expressions'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>funname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&quot;function funname(){console.log('Expressions'); console.log(funname);}&quot;</span>
<span class="token punctuation">}</span>

<span class="token function">funndec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//Declarations</span>
<span class="token function">funname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//error</span>
</code></pre></div><p><strong>第一步 创建全局运行上下文</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638720496804-dd6f462b-2210-46b3-ab3d-13e37a52a97b.webp" alt="img"></p> <p><strong>第二步 找到var声明和函数声明</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638720542562-7dfe2d27-1841-4efb-9c3e-b2508b3b95df.webp" alt="img"></p> <p><strong>第三步 执行语句</strong></p> <p>遇到赋值语句funcOne=function funname(){...}，运行该函数表达式；</p> <p>因为此时已经到了执行语句阶段，所以不会再将变量加入已经编译阶段的Record中，所以此时会创新一个新的词法环境来存放标识符</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638720757533-37db86bc-223e-4558-9de8-d5b2e3407aac.webp" alt="img"></p> <p>函数声明的函数创建过程使用的是当前运行上下文的词法环境，而命名函数表达式创建函数过程新加了一个词法环境，并通过outer与当前运行上下文的词法环境相关联。</p> <p>所以在全局中是没有funname的函数，所以全局调用就会报错。</p> <h3 id="new-function"><a href="#new-function" class="header-anchor">#</a> new Function</h3> <p>使用new Function(arg1,arg2....)创建的函数过程和函数表达式类似，但是不同在于，创建函数使用的scope是直接使用全局词法环境而不管当前的运行上下文，一律取全局词法环境。</p> <p>所以在函数内用new Function创建的函数，只能访问全局变量，因此，不管在哪里用new Function创建函数，都等于在全局上创建。</p> <div class="language-plain extra-class"><pre class="language-plain"><code>var a = 1;

function foo() {

    var a = 2;
    function innerOne(){
        console.log(a)
    }
    
    var innerTwo = new Function(&quot;console.log(a)&quot;)
    
    var innerTree =  function (){
        console.log(a)
    }

    innerOne();
    innerTwo();
    innerTree();
}

foo();//2 1 2 
</code></pre></div><h2 id="函数调用"><a href="#函数调用" class="header-anchor">#</a> 函数调用</h2> <div class="language-plain extra-class"><pre class="language-plain"><code>var a = 2;

function foo() {
    console.log(a)
}

function bar(){
    var a = 5;
    foo()
}

bar()//2 为什么不输出5？
</code></pre></div><p><strong>第一步 创建全局环境</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638721823997-b39fa5d4-c94a-4d1e-a677-a43e4021d60d.webp" alt="img"></p> <p><strong>第二步 扫描声明</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638721837027-e6e0e2ac-2861-42f4-a0fe-8502a880e4a8.webp" alt="img"></p> <p><strong>第三步 执行</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638721846490-614f3dfd-6fcd-43e7-a398-d44b045af85c.webp" alt="img"></p> <p>这时会进入函数foo中的执行，那么就相当于进入一个新环境，要创建一个新的执行上下文</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638721917199-59b78f40-143b-451a-9f65-efaca0449426.webp" alt="img"></p> <p>函数运行时的outer指向创建时候的词法环境，所以此时的outer实际指向了全局词法环境</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638722050787-b8ece1d5-7c60-49ff-8821-7fbdf8f51c32.webp" alt="img"></p> <p>**重要：**就是函数运行时的词法环境和它被调用时那一刹那的词法环境无关，而只与它被创建时的词法环境相关</p> <h2 id="this"><a href="#this" class="header-anchor">#</a> this</h2> <h3 id="global的this"><a href="#global的this" class="header-anchor">#</a> global的this</h3> <p>在进入程序代码之前,创建了全局运行上下文,其中的ThisBinding被设置成了全局对象,所以在全局代码中的this的值为全局对象,浏览器下为window.</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638779703316-50c2bd9c-4a1d-451d-a0dd-a8818e5e8c58.webp" alt="img"></p> <h3 id="函数中的this"><a href="#函数中的this" class="header-anchor">#</a> 函数中的this</h3> <p>函数中的this会比较多变,进入function code之前会设置不同的thisArg,并传递到function code中,进入function code后会创建相关的运行时上下文,并设置ThisBinding为thisArg</p> <p>因此函数中的this与调用时有很大关系.</p> <p>函数中的this和**函数的调用方式相关而与在哪里创建无关,**与函数的词法环境的&quot;静态&quot;相比它是动态的</p> <h3 id="普通函数调用"><a href="#普通函数调用" class="header-anchor">#</a> 普通函数调用</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">functionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>如直接调用和IIFE形式的调用,传到函数里的thisArg是undefined</p> <ul><li>在非strict mode下,普通函数调用中的this为全局对象</li> <li>在strict mode下,普通函数调用中的this为undefined</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>当调用foo时,this.a被解析成全局变量a,因为此时函数调用应用了默认绑定,this指向了全局对象</p> <p>那么我们怎么知道这里应用了默认绑定呢？可以通过分析调用位置来看看 foo() 是如何调用的。在代码中， foo() 是直接使用不带任何修饰的函数引用进行调用的，因此只能使用默认绑定，无法应用其他规则。</p> <h3 id="方法调用"><a href="#方法调用" class="header-anchor">#</a> 方法调用</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>someObj<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>someObj作为thisArg传进函数代码里,在创建运行时上下文时,ThisBinding=someObj</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> someObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span>
    <span class="token function-variable function">print</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> outPrint <span class="token operator">=</span> someObj<span class="token punctuation">.</span>print<span class="token punctuation">;</span>

someObj<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token function">outPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
</code></pre></div><p>outPrint调用时,ThisBinding被设置为全局对象,所以打印2</p> <p>someObj.prin调用时,ThisBinding设置为someObj,所以打印1</p> <p>函数(除箭头函数外)的this只和调用方式相关和在哪里调用相关,与创建无关</p> <h3 id="new调用"><a href="#new调用" class="header-anchor">#</a> new调用</h3> <p>new functionName()方式的调用:创建一个新的对象newObject,并设置ThisBinding=newObject.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有new，普通调用，this为全局对象，在全局对象上创建x=7 y=5</span>
<span class="token keyword">var</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用new调用，this为新创建的对象，在新对象上创建x=7，y=5</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 7</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
</code></pre></div><h3 id="call-apply-bind"><a href="#call-apply-bind" class="header-anchor">#</a> call apply bind</h3> <p>call和apply的调用能够显示将参数 传递给函数thisArg.</p> <p>如果传递给thisArg为null或undefined,在非严格模式下此时的this就是全局对象.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>obj<span class="token punctuation">.</span><span class="token function">myFun</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span><span class="token string">'成都'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">)</span>；　　　　
obj<span class="token punctuation">.</span><span class="token function">myFun</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'成都'</span><span class="token punctuation">,</span><span class="token string">'上海'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><p>call和apply的差别在于给函数传递参数时的差别,call是直接传递,用逗号分隔参数,而apply是用数组进行参数传递.</p> <p>apply是以a开头，它传给fun的参数是Array，也是以a开头的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token function">print</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//window</span>
<span class="token function">print</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//window</span>
<span class="token function">print</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//obj</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">a</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>如果你传入了一个原始值（字符串类型、布尔类型或者数字类型）来当作 this 的绑定对象，这个原始值会被转换成它的对象形式（也就是 new String(..) 、 new Boolean(..) 或者new Number(..) ）。这通常被称为“装箱”。</p> <p>bind的功能是会创建一个和原函数一样的body和[[scope]]的函数,他的this绑定的是bind的第一个参数,其参数绑定显示和call一样</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token string">'azerty'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// azerty</span>
</code></pre></div><h3 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 输出： 10</span>
</code></pre></div><p>等于如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">//等同于，先将传入回调函数记录下来</span>
<span class="token keyword">let</span> callback <span class="token operator">=</span> obj<span class="token punctuation">.</span>foo
<span class="token comment">// 达到触发条件后执行回调</span>
<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 所以foo函数并非作为对象方法调用，而是作为函数普通调用</span>
</code></pre></div><h3 id="箭头函数"><a href="#箭头函数" class="header-anchor">#</a> 箭头函数</h3> <p>箭头函数的this保存为它被创建时的运行上下文的this值,比如在function中创建的箭头函数,它的this保持为在<strong>箭头函数创建时function运行上下文的this值</strong></p> <p><strong>前面提到的函数都是和调用时的运行上下文相关,而箭头函数的this却和创建时的运行上下文相关.</strong></p> <p><strong>注意:对箭头函数调用call apply bind来绑定this是无效的</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> arrowFn1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">arrowFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 输出：window</span>
           <span class="token comment">// 箭头函数没有this绑定，往外层词法环境寻找</span>
           <span class="token comment">// 在foo的词法环境上找到this绑定，指向全局对象window</span>
           <span class="token comment">// 在foo的词法环境上找到，并非是在全局找到的</span>
<span class="token keyword">const</span> arrowFn2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">arrowFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 输出 {a: 1}</span>
window<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 输出： 10</span>

<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> foo
<span class="token punctuation">}</span>
obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 输出： 10</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">bar</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 输出： 10</span>
</code></pre></div><h3 id="案例-2"><a href="#案例-2" class="header-anchor">#</a> 案例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">'window'</span>

<span class="token keyword">var</span> person1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'person1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">show1</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">show2</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">show3</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">show4</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> person2 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'person2'</span> <span class="token punctuation">}</span>

person1<span class="token punctuation">.</span><span class="token function">show1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show1</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span>  <span class="token comment">// ？</span>

person1<span class="token punctuation">.</span><span class="token function">show2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show2</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span>  <span class="token comment">// ？</span>

person1<span class="token punctuation">.</span><span class="token function">show3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show3</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>

person1<span class="token punctuation">.</span><span class="token function">show4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1<span class="token punctuation">.</span><span class="token function">show4</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ？</span>
person1 <span class="token comment">// 函数作为对象方法调用，this指向对象</span>
person2 <span class="token comment">// 使用call间接调用函数，this指向传入的person2</span>
window  <span class="token comment">// 箭头函数无this绑定，在全局环境找到this，指向window</span>
window  <span class="token comment">// 间接调用改变this指向对箭头函数无效</span>
window  <span class="token comment">// person1.show3()返回普通函数，相当于普通函数调用，this指向window</span>
person2 <span class="token comment">// 使用call间接调用函数，this指向传入的person2</span>
window  <span class="token comment">// person1.show3.call(person2)仍然返回普通函数</span>
person1 <span class="token comment">// person1.show4调用对象方法，this指向person1，返回箭头函数，this在person1.show4调用时的词法环境中找到，指向person1</span>
person1  <span class="token comment">// 间接调用改变this指向对箭头函数无效</span>
person2  <span class="token comment">// 改变了person1.show4调用时this的指向，所以返回的箭头函数的内this解析改变</span>
</code></pre></div><h3 id="手写call-apply-bind"><a href="#手写call-apply-bind" class="header-anchor">#</a> 手写call apply bind</h3> <p><strong>手写call</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myCall</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> <span class="token operator">...</span>arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> context <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 指定为 null 和 undefined 的 this 值会自动指向全局对象(浏览器中为window)</span>
        context <span class="token operator">=</span> window 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token comment">// 值为原始值（数字，字符串，布尔值）的 this 会指向该原始值的实例对象</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> specialPrototype <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'特殊属性Symbol'</span><span class="token punctuation">)</span> <span class="token comment">// 用于临时储存函数</span>
    context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 函数的this指向隐式绑定到context上</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过隐式绑定执行函数并传递参数</span>
    <span class="token keyword">delete</span> context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 删除上下文对象的属性</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token comment">// 返回函数执行结果</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>手写apply</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myApply</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> context <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> window <span class="token comment">// 指定为 null 和 undefined 的 this 值会自动指向全局对象(浏览器中为window)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token comment">// 值为原始值（数字，字符串，布尔值）的 this 会指向该原始值的实例对象</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// JavaScript权威指南判断是否为类数组对象</span>
    <span class="token keyword">function</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">&amp;&amp;</span>                                    <span class="token comment">// o不是null、undefined等</span>
            <span class="token keyword">typeof</span> o <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>                <span class="token comment">// o是对象</span>
            <span class="token function">isFinite</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                   <span class="token comment">// o.length是有限数值</span>
            o<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>                        <span class="token comment">// o.length为非负值</span>
            o<span class="token punctuation">.</span>length <span class="token operator">===</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token comment">// o.length是整数</span>
            o<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">4294967296</span><span class="token punctuation">)</span>                  <span class="token comment">// o.length &lt; 2^32</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> specialPrototype <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'特殊属性Symbol'</span><span class="token punctuation">)</span> <span class="token comment">// 用于临时储存函数</span>
    context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 隐式绑定this指向到context上</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取参数数组</span>
    <span class="token keyword">let</span> result
    <span class="token comment">// 处理传进来的第二个参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 是否传递第二个参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'myApply 第二个参数不为数组并且不为类数组对象抛出错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token comment">// 转为数组</span>
            result <span class="token operator">=</span> context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行函数并展开数组，传递函数参数</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行函数 </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">delete</span> context<span class="token punctuation">[</span>specialPrototype<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 删除上下文对象的属性</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token comment">// 返回函数执行结果</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>手写bind</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">fbound</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">var</span> bindArgs <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当作为构造函数时，this 指向实例，self 指向绑定函数，因为下面一句 `fbound.prototype = this.prototype;`，已经修改了 fbound.prototype 为 绑定函数的 prototype，此时结果为 true，当结果为 true 的时候，this 指向实例。</span>
        <span class="token comment">// 当作为普通函数时，this 指向 window，self 指向绑定函数，此时结果为 false，当结果为 false 的时候，this 指向绑定的 context。</span>
        <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">self</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> context<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>bindArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 修改返回函数的 prototype 为绑定函数的 prototype，实例就可以继承函数的原型中的值</span>
    fbound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fbound<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考链接</p> <p>https://juejin.cn/post/6844903906279964686#heading-22</p> <p>https://juejin.cn/post/6844903476623835149#heading-4</p> <h2 id="作用域链"><a href="#作用域链" class="header-anchor">#</a> 作用域链</h2> <p>当我们解析一个变量,就是在当前的运行上下文Excution Context上查找是否有这个变量.</p> <p>运行上下文由词法环境构成:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">ExecutionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>LexicalEnvironment <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>VariableEnvironment <span class="token operator">=</span>  <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ThisBinding <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">LexicalEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>EnvironmentRecord <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outer <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">//outer Environment Reference</span>
<span class="token punctuation">}</span>
</code></pre></div><p>函数内的变量是登记在当前词法环境的环境记录Environment Record中,函数如何访问到全局变量,这些变量并没有登记在函数的环境记录中</p> <p>通过LexicalEnvironment的outer</p> <p>函数运行时的LexcialEnvironment是指向函数对象的[[scope]],而函数对象的[[scope]]保存着函数创建时的词法环境.因此函数中可访问的词法环境范围就是:</p> <p><strong>函数自己的词法环境+函数创建时的词法环境</strong></p> <p><strong>这样一个个函数的词法环境链接在一起,就形成了作用域链</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> bestAvenger <span class="token operator">=</span> <span class="token string">&quot;global&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> bestActor <span class="token operator">=</span> <span class="token string">&quot;in a&quot;</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bestAvenger<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;global&quot;;</span>
    
  <span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bestC <span class="token operator">=</span> <span class="token string">&quot;in c&quot;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bestActor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;in a&quot;;</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bestC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//**not defined error**</span>
<span class="token punctuation">}</span>

<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>创建全局运行时上下文:</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793002720-6e2cc926-3023-423c-961a-18161082f740.webp" alt="img"></p> <p><strong>开始登记声明:</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793021345-c31b3b22-af6f-4e73-aa4f-cc5ad279cbe6.webp" alt="img"><strong>执行代码</strong></p> <p><strong>遇到a的调用时要创建a的运行时上下文</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793067140-31c872e6-8736-4bed-845c-4941c1f6ecc7.webp" alt="img"></p> <p><strong>登记声明</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793086043-9b595f86-8a07-4b32-ae5d-e0e2171dfcea.webp" alt="img"></p> <p><strong>执行a中的代码</strong></p> <p>遇到bestAvenger时,会先查找自己的环境记录,查询不到再沿着outer向外查找,如绿色虚线</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793217608-5933a15e-0bc2-4768-8940-2b78234086b6.webp" alt="img"></p> <p><strong>接下来c的调用和b的调用也一样</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793250757-b8133bb2-f939-4e41-a07b-409e0dbc2327.webp" alt="img"></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638793256547-350b10e4-8125-46f2-8a0d-548fc57d82a2.webp" alt="img"></p> <p><strong>在b的调用中,它的可访问词法环境中均无bestC,所以报错</strong></p> <h2 id="闭包"><a href="#闭包" class="header-anchor">#</a> 闭包</h2> <p>我们知道在进入函数运行的时候,会创建函数的运行上下文并放在栈顶:</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638795070569-e17da955-f630-4f1d-afdf-8f37618cfebd.webp" alt="img"></p> <p>函数运行完毕的时候,就会将函数运行上下文弹出</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638795087656-d22776ed-527c-442c-a292-5b873e335938.webp" alt="img"></p> <p>可以发现对上次运行的函数时创建的词法环境的访问链路断掉了,无法再引用函数词法环境里的变量.</p> <p>如何保存?</p> <p>函数创建时会把创建函数时的<strong>上下文词法环境保存进函数的[[scope]].</strong></p> <p>因此,如果在<strong>函数运行的上下文创建一个函数</strong>,这个函数的scope就可以保存父级函数运行时的词法环境了,并且把这个<strong>函数返回,赋值给全局的变量</strong>.那么就可以通过全局访问函数内部的词法环境了,访问这些&quot;失联的词法环境&quot;.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> inFunction <span class="token operator">=</span> <span class="token string">'inFunction'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>inFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> inFunction <span class="token operator">=</span> inFunction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> inner
<span class="token punctuation">}</span>

<span class="token keyword">var</span> inner <span class="token operator">=</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2021/webp/22799595/1638795346131-5eefc1e9-67a1-45e9-a54d-a8b108bfa573.webp" alt="img"></p> <h3 id="闭包的定义"><a href="#闭包的定义" class="header-anchor">#</a> 闭包的定义</h3> <p>从上面的过程来看,闭包就是:</p> <p>当函数可以记住并访问所在的词法作用域，即使函数是在当前词法作用域之外执行，这时就产生了闭包。所以闭包，其实就是通过某种方式把“失联”词法环境的引用引到全局环境来。因为这词法环境现在只有外围函数返回时提供的引用作为入口，只有一个洞可以进去，是一个密闭的空间，故而叫做闭包吧。闭包是函数和声明该函数的词法环境的组合</p> <h3 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h3> <ul><li>创建私有变量</li> <li>延长变量的生命周期</li></ul> <p><strong>1.模拟块级作用域</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> message <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">wait</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello, closure!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将一个内部函数timer传递给setTimeout,timer具有涵盖wait作用域的闭包,因此还保有对变量message的引用</p> <p>wait函数执行1000ms后,它的内部作用域不会消失,timer函数依然保有wait函数作用域的闭包</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据作用域的工作原理,虽然循环时出现的五个函数是在各个迭代中分别定义的,但是它们都被封闭在<strong>一个共享的全局作用域中,因此实际上只有一个i,所以输出五次6</strong></p> <p>如果想让输出可以完成1 2 3 4 5 的输出,我们需要更多的闭包作用域,特别是在循环过程中每个迭代都需要一个闭包作用域</p> <p>因为IIFE会通过声明并立即执行一个函数来创建作用域,所以修改如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> i<span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是此时每个IIFE都还是一个个什么都没有的空作用域,它需要有自己的变量,用来在每个迭代中储存i的值</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">j</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> j <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> j<span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在迭代内使用IIFE会为每个迭代都生产一个新的作用域,使得延迟函数的回调都可以将新的作用域封闭在每个迭代内部,每个迭代中都会含有一个具有准确值的变量供我们访问.</p> <p><strong>2.实现js模块</strong></p> <p><strong>模块模式是</strong>指将所有的数据和功能都封闭在一个函数内部(私有的),只向外暴露一个含有多个属性方法的对象或函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> privateCounter <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">function</span> <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        privateCounter <span class="token operator">+=</span> val
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">decrement</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">changeBy</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> privateCounter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>3.函数的柯里化</strong></p> <p><strong>柯里化的目的是在于避免频繁调用具有相同参数函数的同时,又能够轻松重用</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 假设我们有一个求长方形面积的函数</span>
<span class="token keyword">function</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> width <span class="token operator">*</span> height
<span class="token punctuation">}</span>
<span class="token comment">// 如果我们碰到的长方形的宽老是10</span>
<span class="token keyword">const</span> area1 <span class="token operator">=</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> area2 <span class="token operator">=</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> area3 <span class="token operator">=</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>

<span class="token comment">// 我们可以使用闭包柯里化这个计算面积的函数</span>
<span class="token keyword">function</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token parameter">width</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token parameter">height</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> width <span class="token operator">*</span> height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getTenWidthArea <span class="token operator">=</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// 之后碰到宽度为10的长方形就可以这样计算面积</span>
<span class="token keyword">const</span> area1 <span class="token operator">=</span> <span class="token function">getTenWidthArea</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>

<span class="token comment">// 而且如果遇到宽度偶尔变化也可以轻松复用</span>
<span class="token keyword">const</span> getTwentyWidthArea <span class="token operator">=</span> <span class="token function">getArea</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="案例-3"><a href="#案例-3" class="header-anchor">#</a> 案例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>o</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fun</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fun</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// ?</span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// ?        </span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// ?</span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// ?</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ?</span>

<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// ?</span>
c<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// ?</span>
c<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// ?</span>
<span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span>o</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fun</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fun</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 运行fun(0)，未传入第二个参数，故打印undefined，最后返回一个对象，内有一个fun方法</span>
<span class="token comment">// （注意此方法与外部fun函数不同，下同）</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// undefined</span>
<span class="token comment">// 对象内fun方法为闭包，记录对fun(0)执行时的词法环境，内部绑定一个参数n，值为0</span>
<span class="token comment">// 将返回对象赋值于a，执行a.fun(x)时，不管传入的第一个参数是什么</span>
<span class="token comment">// 第二个参数n都将在之前fun(0)执行时的词法环境内找到，值为0</span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 0        </span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 0</span>
a<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 0</span>

<span class="token comment">// 每次调用fun函数都会返回一个对象</span>
<span class="token comment">// 对象内又一个fun方法，为闭包，记录创建该对象及对象方法时的词法环境</span>
<span class="token comment">// 故每次调用对象的fun方法，内部执行fun函数时的第二个参数总会在创建该对象时的词法环境内找到</span>
<span class="token comment">// 值即为创建该对象的函数的第一个参数</span>
<span class="token comment">// 所以除了第一次打印值为undefined，其余皆为上次调用fun时传入的第一个参数</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// undefined</span>
                                      <span class="token comment">// 0</span>
                                      <span class="token comment">// 1</span>
                                      <span class="token comment">// 2</span>

<span class="token comment">// 类似上面的分析，c为一个对象，有一个fun方法，为闭包</span>
<span class="token comment">// 该闭包记录了创建它时的词法环境，上面有两个绑定，{n: 1, o: 0}</span>
<span class="token comment">// 所以c.fun(x)类似调用时，不论传参是什么，都将打印1</span>
<span class="token comment">// 需要注意fun(0)调用时打印了undefined，fun(0).fun(1)调用时打印了0</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// undefined</span>
                                      <span class="token comment">// 0</span>
c<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 1</span>
c<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// 1</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/RunHio-s-Blog/handbook/GC.html" class="prev">
            GC
          </a></span> <span class="next"><a href="/RunHio-s-Blog/handbook/Promise.html">
            Promise
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#lexical-environments" class="sidebar-link reco-side-lexical-environments" data-v-cb1513f6>Lexical Environments</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#environmentrecord" class="sidebar-link reco-side-environmentrecord" data-v-cb1513f6>EnvironmentRecord</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#全局环境" class="sidebar-link reco-side-全局环境" data-v-cb1513f6>全局环境</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#globalenvironment" class="sidebar-link reco-side-globalenvironment" data-v-cb1513f6>GlobalEnvironment</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#案例分析" class="sidebar-link reco-side-案例分析" data-v-cb1513f6>案例分析</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#全局标识符解析" class="sidebar-link reco-side-全局标识符解析" data-v-cb1513f6>全局标识符解析</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#execution-context" class="sidebar-link reco-side-execution-context" data-v-cb1513f6>Execution Context</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#execution-context-2" class="sidebar-link reco-side-execution-context-2" data-v-cb1513f6>Execution Context</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#hoisting" class="sidebar-link reco-side-hoisting" data-v-cb1513f6>Hoisting</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#lexicalenvironment和variableenvironment" class="sidebar-link reco-side-lexicalenvironment和variableenvironment" data-v-cb1513f6>LexicalEnvironment和VariableEnvironment</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#案例" class="sidebar-link reco-side-案例" data-v-cb1513f6>案例</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#函数创建" class="sidebar-link reco-side-函数创建" data-v-cb1513f6>函数创建</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#scope-属性" class="sidebar-link reco-side-scope-属性" data-v-cb1513f6>[[scope]]属性</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#函数表达式和函数声明" class="sidebar-link reco-side-函数表达式和函数声明" data-v-cb1513f6>函数表达式和函数声明</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#new-function" class="sidebar-link reco-side-new-function" data-v-cb1513f6>new Function</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#函数调用" class="sidebar-link reco-side-函数调用" data-v-cb1513f6>函数调用</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#this" class="sidebar-link reco-side-this" data-v-cb1513f6>this</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#global的this" class="sidebar-link reco-side-global的this" data-v-cb1513f6>global的this</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#函数中的this" class="sidebar-link reco-side-函数中的this" data-v-cb1513f6>函数中的this</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#普通函数调用" class="sidebar-link reco-side-普通函数调用" data-v-cb1513f6>普通函数调用</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#方法调用" class="sidebar-link reco-side-方法调用" data-v-cb1513f6>方法调用</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#new调用" class="sidebar-link reco-side-new调用" data-v-cb1513f6>new调用</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#call-apply-bind" class="sidebar-link reco-side-call-apply-bind" data-v-cb1513f6>call apply bind</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#回调函数" class="sidebar-link reco-side-回调函数" data-v-cb1513f6>回调函数</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#箭头函数" class="sidebar-link reco-side-箭头函数" data-v-cb1513f6>箭头函数</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#案例-2" class="sidebar-link reco-side-案例-2" data-v-cb1513f6>案例</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#手写call-apply-bind" class="sidebar-link reco-side-手写call-apply-bind" data-v-cb1513f6>手写call apply bind</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#作用域链" class="sidebar-link reco-side-作用域链" data-v-cb1513f6>作用域链</a></li><li class="level-2" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#闭包" class="sidebar-link reco-side-闭包" data-v-cb1513f6>闭包</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#闭包的定义" class="sidebar-link reco-side-闭包的定义" data-v-cb1513f6>闭包的定义</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#应用" class="sidebar-link reco-side-应用" data-v-cb1513f6>应用</a></li><li class="level-3" data-v-cb1513f6><a href="/RunHio-s-Blog/handbook/Context.html#案例-3" class="sidebar-link reco-side-案例-3" data-v-cb1513f6>案例</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/RunHio-s-Blog/assets/js/app.cc02781b.js" defer></script><script src="/RunHio-s-Blog/assets/js/3.d30309d1.js" defer></script><script src="/RunHio-s-Blog/assets/js/1.600c0749.js" defer></script><script src="/RunHio-s-Blog/assets/js/13.032ea566.js" defer></script>
  </body>
</html>